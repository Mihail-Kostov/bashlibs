#!/bin/bash
my_real_dir() {
    if [[ $(type -t progdir) == function ]]
    then
        progdir
    else
        dirname $(realpath $(echo $0 | sed "s/$(basename $0)/bake/"))
    fi
}

source $(my_real_dir)/bake-intree-init > /dev/null 2>&1 \
    || $(bashlibs --load-base)
include verbose.sh
set_verbose_level_to_info
include bake_config.sh

hosts() {
    args \
        | sed 's/-s//g' \
        | sed 's/--server//g'
}

main() {
    $(progdir)/bake \
        $(args) \
		-p cmake-macros \
		-p bashlibs-cmake-macros \
		-p bashlibs-shunit2-enhancements \
		-p bashlibs-colors \
		-p bashlibs-verbose \
		-p bashlibs-usage \
		-p bashlibs-directories \
		-p bashlibs-file-manipulations \
		-p bashlibs-code-clarity \
		-p bashlibs-base \
		-p bashlibs-utils \
		-p bashlibs-date \
		-p bashlibs-grub \
		-p bashlibs-initramfs \
		-p bashlibs-math \
		-p bashlibs-os-detection \
		-p bashlibs-string \
		-p bashlibs-build-utils \
		-p bashlibs-kernel-cmdline \
		-p bashlibs-disks \
		-p bashlibs-qemu

    for host in $(hosts)
    do
        ssh root@$host bashlibs -v -v --test all
    done

}
main
